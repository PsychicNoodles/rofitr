#!/usr/bin/env bash
# Copyright (C) 2019 Yusuf Aktepe <yusuf@yusufaktepe.com>

## Set defaults
# SOURCE="en"               # source language code
# TARGET="tr"               # translation language code
# ENGINE="google"           # google, yandex or bing
# LOCALE="en"               # translator language ($LANG var. by default)
# SPEAK_SOURCE="false"      # speak the source (true/false)
# SPEAK_TRANSLATION="false" # speak the translation (true/false)

## Rofi general options
# leave these empty or comment out to use system defaults:
FONT="mono 10"
WIDTH="60"
LOCATION="2"
YOFFSET="20"

# use alternative config and theme
# CONFIG="~/.config/rofi/translate-config.rasi"
# THEME="/usr/share/rofi/themes/lb.rasi"

## Rofi required options
HIST_LINES="15" # lines to show for history mode
RES_LINES="42"  # limit output to screen height
PROMPT_TR=" translate"
PROMPT_HIST=" history"
PROMPT_DEL=" delete"
CLR_RESULT="#ebdbb2"    # text color for translation
CLR_HELP_HLBG="#b8bb26" # help mode highlight background
CLR_HELP_HLFG="#1d2021" # help mode highlight foreground

HIST="${XDG_DATA_HOME:-~/.local/share}/rofi/rofitr_history"
mkdir -p "$(dirname "$HIST")"

help() {
cat <<EOF
# <u>Translate with defaults</u>
> <span background="$CLR_HELP_HLBG" foreground="$CLR_HELP_HLFG"><b><i>text</i></b></span>
# <u>Override default SOURCE and TARGET</u>
> <span background="$CLR_HELP_HLBG" foreground="$CLR_HELP_HLFG"><b>en:es <i>text</i></b></span>
# <u>Auto-detect SOURCE</u>
> <span background="$CLR_HELP_HLBG" foreground="$CLR_HELP_HLFG"><b>:en <i>text</i></b></span>
<s>                                             </s>
<u>Actions:</u>
<span foreground="$CLR_HELP_HLBG"><b>!e</b></span> <i>word</i> => show examples for "word"
<span foreground="$CLR_HELP_HLBG"><b>!s</b></span> <i>text</i> => speak the "text"
<span foreground="$CLR_HELP_HLBG"><b>!!</b></span>      => show last translation
<span foreground="$CLR_HELP_HLBG"><b>!!e</b></span>     => show examples for last translation
<span foreground="$CLR_HELP_HLBG"><b>!!s</b></span>     => speak last translation
<span foreground="$CLR_HELP_HLBG"><b>!</b></span>       => select and translate from history
<span foreground="$CLR_HELP_HLBG"><b>!d</b></span>      => select and remove from history
<span foreground="$CLR_HELP_HLBG"><b>!dd</b></span>     => clear history (in delete mode)
<s>                                             </s>
<u>Command line:</u>
$ rofitr :ru <i>text</i> <span foreground="$CLR_HELP_HLBG">=> </span>Translate into Russian
$ rofitr -s       <span foreground="$CLR_HELP_HLBG">=> </span>Translate from primary selection
EOF
}

rofi_cmd() {
	[ -n "$CONFIG" ] && params+=(-config "$CONFIG")
	[ -n "$THEME" ] && params+=(-theme "$THEME")
	[ -n "$WIDTH" ] && params+=(-width "$WIDTH")
	[ -n "$LOCATION" ] && params+=(-location "$LOCATION")
	[ -n "$YOFFSET" ] && params+=(-yoffset "$YOFFSET")
	[ -n "$FONT" ] && params+=(-font "$FONT")

	rofi -dmenu "${params[@]}" "$@"
}

crow_cmd() {
	[ -n "$ENGINE" ] && crowparams+=(-e "$ENGINE")
	[ -n "$LOCALE" ] && crowparams+=(-l "$LOCALE")
	[ "$SPEAK_TRANSLATION" = "true" ] && crowparams+=(-p)
	[ "$SPEAK_SOURCE" = "true" ] && crowparams+=(-u)

	crow "${crowparams[@]}" "$@"
}

cleanup() {
	sedit="s/^[\t]$//;/^$/d;s/\&/\&amp\;/g"
	case "$1" in
		ex) sed -e "$sedit" -ne '/- examples:/,$p' | head -n $RES_LINES ;;
		s) sed -e "$sedit" | sed -z 's/\n*(/ (/'| head -n $RES_LINES ;;
		*) sed -e "$sedit" -e '/- examples:/Q' | sed -z 's/\n*(/ (/' | head -n $RES_LINES
	esac
}

cklang() {
	lslang=(
		"af" "sq" "am" "ar" "hy" "az" "eu" "ba" "be" "bn" "bs" "bg" "ca" "yue" "ceb"
		"zh-CN" "zh-TW" "co" "hr" "cs" "da" "nl" "en" "eo" "et" "fj" "fil" "fi" "fr"
		"fy" "gl" "ka" "de" "el" "gu" "ht" "ha" "haw" "he" "mrj" "hi" "hmn" "hu" "is"
		"ig" "id" "ga" "it" "ja" "jw" "kn" "kk" "km" "tlh" "tlh-Qaak" "ko" "ku" "ky" "lo"
		"la" "lv" "apc" "lt" "lb" "mk" "mg" "ms" "ml" "mt" "mi" "mr" "mhr" "mn" "my" "ne"
		"no" "ny" "pap" "ps" "fa" "pl" "pt" "pa" "otq" "ro" "ru" "sm" "gd" "sr-Cyrl"
		"sr-Latin" "st" "sn" "sd" "si" "sk" "sl" "so" "es" "su" "sw" "sv" "tl" "ty" "tg"
		"ta" "tt" "te" "th" "to" "tr" "udm" "uk" "ur" "uz" "vi" "cy" "xh" "yi" "yo" "yua"
	)
	printf '%s\n' "${lslang[@]}" | grep -x "$1"
}

append_hist() {
	sed -i "/^$input$/d" "$HIST"
	printf '%s\n' "$input" >> "$HIST"
}

return_result() {
	input="$(rofi_cmd -p "$PROMPT_TR" -l 0 -mesg "<span color='$CLR_RESULT'>$result</span>")"
}

[ -n "$*" ] && input="$*" || input="$(rofi_cmd -p "$PROMPT_TR" -l 0)"

while [ -n "$input" ]; do
	case "$input" in
		"?")	input="$(rofi_cmd -p "Usage" -l 0 -mesg "<span color='$CLR_RESULT'>$(help)</span>")" ;;
		!)	input="$(tac "$HIST" | rofi_cmd -p "$PROMPT_HIST" -l "$HIST_LINES")"
			[ "$input" = "!" ] && input="$(rofi_cmd -p "$PROMPT_TR" -l 0)" ;;
		!!)	input=$(tail -n1 "$HIST") ;;
		!!e)	input=$(printf "!e %s" "$(tail -n1 "$HIST")") ;;
		!!s)	input=$(printf "!s %s" "$(tail -n1 "$HIST")") ;;
		!d)	pattern="$(tac "$HIST" | rofi_cmd -p "$PROMPT_DEL" -l "$HIST_LINES")"
			case "$pattern" in
				!) input="$(rofi_cmd -p "$PROMPT_TR" -l 0)" ;;
				!dd) printf '' > "$HIST" && exit 0 ;;
				"") exit 0 ;;
				*) sed -i "/^$pattern$/d" "$HIST"
			esac ;;
		??*:??*)
			SOURCE=$(cklang "$(echo "$input" | awk -F':' '{print $1}')")
			TARGET=$(cklang "$(echo "$input" | awk -F'[:| ]' '{print $2}')")
			input=$(echo "$input" | cut -d' ' -f2-)
			result=$(crow_cmd -s "${SOURCE:-en}" -t "${TARGET:-tr}" -- "$input" | cleanup)
			unset SOURCE TARGET
			append_hist; return_result ;;
		:??*)
			TARGET=$(cklang "$(echo "$input" | awk -F'[:| ]' '{print $2}')")
			input=$(echo "$input" | cut -d' ' -f2-)
			result=$(crow_cmd -t "${TARGET:-tr}" -- "$input" | cleanup)
			unset TARGET
			append_hist; return_result ;;
		!e*)
			input=$(echo "$input" | cut -d' ' -f2-)
			result=$(crow_cmd -- "$input" | cleanup ex)
			append_hist; return_result ;;
		!s*)
			input=$(echo "$input" | cut -d' ' -f2-)
			result=$(SPEAK_SOURCE="true" crow_cmd -- "$input" | cleanup s)
			append_hist; return_result ;;
		-s)
			input=$(xclip -o); [ -z "$input" ] && exit
			result=$(crow_cmd -t "${TARGET:-tr}" -- "$input" | cleanup)
			append_hist; return_result ;;
		*)
			result=$(crow_cmd -s "${SOURCE:-en}" -t "${TARGET:-tr}" -- "$input" | cleanup)
			append_hist; return_result ;;
	esac
done
